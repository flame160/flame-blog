import{_ as e,c as o,I as n,E as t,V as l,J as c,o as r,a as i}from"./chunks/framework.2c88e6e5.js";const p="/flame-blog/img/platform/xyd_security.png",m="/flame-blog/img/platform/xyd_pos_decode.png",_="/flame-blog/img/platform/xyd_62.png",d="/flame-blog/img/platform/xyd_32_4.png",g="/flame-blog/img/platform/xyd_mak_decode.png",u="/flame-blog/img/platform/xyd_checkvalue.png",a="/flame-blog/img/platform/xyd_encode_mac.png",y="/flame-blog/img/platform/xyd_mac.png",h="/flame-blog/img/platform/xyd_mac_equals.png",P=JSON.parse('{"title":"新一代mac计算","description":"","frontmatter":{},"headers":[],"relativePath":"platform/xyd/mac.md","filePath":"platform/xyd/mac.md"}'),b={name:"platform/xyd/mac.md"},f=l('<h1 id="新一代mac计算" tabindex="-1">新一代mac计算 <a class="header-anchor" href="#新一代mac计算" aria-label="Permalink to &quot;新一代mac计算&quot;">​</a></h1><h2 id="_1-测试环境加密机程序" tabindex="-1">（1）测试环境加密机程序 <a class="header-anchor" href="#_1-测试环境加密机程序" aria-label="Permalink to &quot;（1）测试环境加密机程序&quot;">​</a></h2><ul><li>各个新一代上的：$HOME/modules/bin/UmsSecurity</li><li>216上加密机程序代码：$HOME/modules/security</li></ul><img src="'+p+'" data-fancybox="gallery"><h2 id="_2-应用解包错误" tabindex="-1">（2）应用解包错误 <a class="header-anchor" href="#_2-应用解包错误" aria-label="Permalink to &quot;（2）应用解包错误&quot;">​</a></h2><p>看pin里面的报错哪个域解析错误，一般增值交易发到传统了，将<strong>estpduinfo表</strong>里面对应的1改成2。</p><img src="'+m+'" data-fancybox="gallery"><h2 id="_3-签到返回算mak" tabindex="-1">（3）签到返回算MAK <a class="header-anchor" href="#_3-签到返回算mak" aria-label="Permalink to &quot;（3）签到返回算MAK&quot;">​</a></h2><ul><li>对于单倍长密钥算法，前12个字节为PIN的工作密钥的密文，后12个字节为MAC的工作密钥的密文。（其中，前8个字节是密文，后4个字节是checkvalue；前8个字节解出明文后，对8个数值0做单倍长密钥算法，取结果的前四位与checkvalue 的值比较应该是一致的）。</li><li>对于双倍长密钥算法，前20个字节为PIN的工作密钥的密文，后20个字节为MAC的工作密钥的密文。（其中，“PIN工作密钥”前16个字节是密文，后4个字节是checkvalue；前16个字节解出明文后，对8个数值0做双倍长密钥算法，取结果的前四位与checkvalue 的值比较应该是一致的；“MAC工作密钥”前8个字节是密文，再8个字节是二进制零，后4个字节是checkvalue；前8个字节解出明文后，对8个数值0做单倍长密钥算法，取结果的前四位与checkvalue 的值比较应该是一致的）。</li></ul>',9),A=l(`<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">84772dae453ec6d67583327b0237513268d0648c</span></span>
<span class="line"><span style="color:#FFCB6B;">90f1788856631952000000000000000044b1eb7c</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><img src="`+_+'" data-fancybox="gallery"><p><strong>终端主密钥32个4进行解密：85E52F31E03E5ECD</strong></p><img src="'+d+'" data-fancybox="gallery"><p><strong>hsm_key中MAK进行解密，保护密钥16个2和16个1，为85E52F31E03E5ECD</strong></p><img src="'+g+'" data-fancybox="gallery"><p><strong>checkvalue计算</strong></p><img src="'+u+`" data-fancybox="gallery"><h2 id="_4-mac计算-算出mak-用mak对报文加密的mac" tabindex="-1">（4）mac计算（算出MAK，用MAK对报文加密的MAC） <a class="header-anchor" href="#_4-mac计算-算出mak-用mak对报文加密的mac" aria-label="Permalink to &quot;（4）mac计算（算出MAK，用MAK对报文加密的MAC）&quot;">​</a></h2><ul><li>查看主密钥表hsm_tmk，其中TMK为主密钥密文，测试环境通过16个2和16个1加密，明文为32个4。</li><li>查看工作密钥表hsm_key，其中PIK为用于加密PIN的密钥，MAK为用于生成验证报文mac的密钥。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> hsm_tmk; </span><span style="color:#89DDFF;">//</span><span style="color:#A6ACCD;">查看主密钥表</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> hsm_key; </span><span style="color:#89DDFF;">//</span><span style="color:#A6ACCD;">查看工作密钥表</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>终端通过62域签到报文17B4B586B689D4A4通过主密钥32个4进行解密，得到MAK明文（85EAA286A892DA6D），终端用其对报文加密得到MAC。</li></ul><img src="`+a+'" data-fancybox="gallery"><ul><li>新一代通过hsm_key表中的MAK字段用32个2和32个1进行解密，得到MAK明文。</li></ul><img src="'+a+'" data-fancybox="gallery"><ul><li>MAC计算</li></ul><img src="'+y+'" data-fancybox="gallery"><ul><li>用于计算MAC的报文去掉前面后面的MAC，最终计算结果为241E08B2D7988DAD，比较相等</li></ul><img src="'+h+'" data-fancybox="gallery">',19);function C(x,k,D,M,v,F){const s=c("font");return r(),o("div",null,[f,n(s,{color:"red"},{default:t(()=>[i("签到返回62域：")]),_:1}),A])}const T=e(b,[["render",C]]);export{P as __pageData,T as default};
